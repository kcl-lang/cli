# Reference from:
# https://goreleaser.com/ci/actions/
name: Release
on:
  push:
    tags:
      - "v*"
permissions:
  contents: write
jobs:
  image:
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
      image_url: ${{ steps.hash.outputs.image_url }}
      image_digest: ${{ steps.hash.outputs.image_digest }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker login ghcr.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: kclbot
          password: ${{ secrets.DEPLOY_ACCESS_TOKEN }}
      - name: Docker login docker.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: |
            kcllang/kcl
            ghcr.io/kcl-lang/kcl

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          sbom: true
          provenance: true
          push: true
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  binary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.DEPLOY_ACCESS_TOKEN }}

  musl-binary:
    needs: binary
    runs-on: ubuntu-latest
    container: golang:1.24-alpine
    steps:
      - name: Git checkout
        uses: actions/checkout@v6

      - name: Install musl dependencies (Alpine container)
        run: |
          apk add --no-cache \
            musl-dev \
            gcc \
            git \
            make \
            linux-headers \
            tar

      - name: Compile KCL (musl static build)
        run: |
          CGO_ENABLED=1 go build -tags="musl netgo static osusergo" -ldflags="-linkmode external -extldflags '-static'" ./cmd/kcl
        env:
          CGO_LDFLAGS: '-static'

      - name: Package musl binary with docs
        run: |
          TAG_NAME=${{ github.ref_name }}
          mkdir -p kcl-musl-package
          cp -f ./kcl ./kcl-musl-package/
          cp -f ./README.md ./kcl-musl-package/
          cp -f ./LICENSE ./kcl-musl-package/
          tar -czf kcl-${TAG_NAME}-linux-musl-amd64.tar.gz -C kcl-musl-package .
          ls -lh kcl-${TAG_NAME}-linux-musl-amd64.tar.gz
          echo "PACKAGE_NAME=kcl-${TAG_NAME}-linux-musl-amd64.tar.gz" >> $GITHUB_ENV

      - name: Upload musl package to Artifact
        uses: actions/upload-artifact@v6
        with:
          name: kcl-musl-package
          path: ./${{ env.PACKAGE_NAME }}
          retention-days: 7

  upload-musl-to-release:
    needs: [binary, musl-binary]
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v6

      - name: Download musl package from Artifact
        uses: actions/download-artifact@v8
        with:
          name: kcl-musl-package
          path: ./

      - name: Install GitHub CLI
        run: |
          sudo apt update && sudo apt install -y gh

      - name: Upload to GitHub Release
        run: |
          echo "${{ secrets.DEPLOY_ACCESS_TOKEN }}" | gh auth login --with-token
          PACKAGE_NAME=$(ls ./kcl-*.tar.gz)
          gh release upload "${{ github.ref_name }}" "${PACKAGE_NAME}" --clobber
        env:
          GITHUB_API_URL: https://api.github.com
